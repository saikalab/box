#!/system/bin/sh

scripts_dir="${0%/*}"
source /data/adb/box/settings.ini

PROPFILE="/data/adb/modules/box_for_root/module.prop"

find_packages_uid() {
  local uid_log="${box_run}/uid.log"

  # --- 1. åˆå§‹åŒ–ï¼Œåˆ›å»ºè¦†ç›–å†™å…¥çš„æ—¥å¿—æ–‡ä»¶ ---
  echo "--- Box UID/GID æŸ¥è¯¢æ—¥å¿— ---" > "${uid_log}"
  echo "$(date)" >> "${uid_log}"
  echo "[Info] ä»£ç†æ¨¡å¼: ${proxy_mode}" >> "${uid_log}"
  echo "" >> "${uid_log}"
  echo "--- ä» package.list.cfg è¯»å–çš„åˆ—è¡¨ ---" >> "${uid_log}"
  echo "[Debug] ç»Ÿä¸€åº”ç”¨åˆ—è¡¨: ${packages_list_multiuser[*]}" >> "${uid_log}"
  echo "[Debug] GID åˆ—è¡¨: ${gid_list[*]}" >> "${uid_log}"
  echo "----------------------------------------" >> "${uid_log}"
  echo "" >> "${uid_log}"

  # æ¸…ç©ºæœ€ç»ˆçš„ UID åˆ—è¡¨æ–‡ä»¶
  > "${uid_list}"

  # --- 2. å¤„ç†åŒ…åå¹¶è®°å½•æ—¥å¿— ---
  echo "--- å¤„ç†ç»“æœ ---" >> "${uid_log}"

  # ç»Ÿä¸€å¤„ç†æ‰€æœ‰å¸¦ç”¨æˆ·IDå‰ç¼€çš„åŒ…å
  for entry in "${packages_list_multiuser[@]}"; do
    prefix="${entry%%:*}"
    package="${entry#*:}"
    
    local base_uid
    base_uid=$(busybox awk -v p="^${package}$" '$1 ~ p {print $2; exit}' "${system_packages_file}")
    if [ -n "${base_uid}" ]; then
      local multiuser_uid=$((base_uid + prefix * 100000))
      echo "${multiuser_uid}" >> "${uid_list}"
      echo "[Info] Success: ç”¨æˆ· ${prefix} åº”ç”¨: ${package} -> ${multiuser_uid}" >> "${uid_log}"
    else
      echo "[Warning] Failure: ç”¨æˆ· ${prefix} åº”ç”¨: ${package} -> æœªæ‰¾åˆ°" >> "${uid_log}"
    fi
  done

  # --- 3. æ’åºå»é‡å¹¶ç”Ÿæˆæœ€ç»ˆç»“æœæ—¥å¿— ---
  # å¦‚æœåˆ—è¡¨ä¸ä¸ºç©ºï¼Œåˆ™æ’åºå’Œå»é‡
  if [ -s "${uid_list}" ]; then
    local temp_uid_list="${box_run}/temp_uid.list"
    busybox sort -un "${uid_list}" > "${temp_uid_list}"
    mv "${temp_uid_list}" "${uid_list}"
  fi

  echo "" >> "${uid_log}"
  echo "--- ç”¨äº iptables çš„æœ€ç»ˆåˆ—è¡¨ ---" >> "${uid_log}"
  echo "[Debug] æœ€ç»ˆ GID åˆ—è¡¨: ${gid_list[*]}" >> "${uid_log}"
  echo "[Debug] æœ€ç»ˆ UID åˆ—è¡¨ (æ¥è‡ª ${uid_list}):" >> "${uid_log}"
  # ä½¿ç”¨ cat è€Œä¸æ˜¯ echoï¼Œä»¥é˜²åˆ—è¡¨è¿‡é•¿
  cat "${uid_list}" >> "${uid_log}"
  echo "---------------------------------" >> "${uid_log}"
}

log_service_results() {
    local core_name="$1"
    local proxy_mode_type="$2" # include or exclude
    local uids="$3"

    echo "" >> "${box_run}/uid.log"
    echo "--- ${core_name} æœåŠ¡å¤„ç†ç»“æœ ---" >> "${box_run}/uid.log"
    echo "æ—¶é—´: $(date)" >> "${box_run}/uid.log"
    echo "[Info] æ“ä½œ: æ›´æ–°TUNæ¨¡å¼UIDåˆ—è¡¨" >> "${box_run}/uid.log"
    
    if [ -n "$uids" ]; then
        echo "[Info] æ¨¡å¼: ${proxy_mode_type}" >> "${box_run}/uid.log"
        echo "[Debug] åº”ç”¨çš„ UIDs: ${uids}" >> "${box_run}/uid.log"
    else
        echo "[Info] æ¨¡å¼: ${proxy_mode_type}" >> "${box_run}/uid.log"
        echo "[Debug] åº”ç”¨çš„ UIDs: (æ— )" >> "${box_run}/uid.log"
    fi
    echo "-----------------------------" >> "${box_run}/uid.log"
}

box_check_logs() {
  # åˆ é™¤æ‰€æœ‰å†…æ ¸æ—¥å¿—å¹¶å¤‡ä»½
  log Info "åˆ é™¤å¹¶å¤‡ä»½æ—¥å¿—æ–‡ä»¶"
  (
    for bin in "${bin_list[@]}"; do
      if [ -f "${box_run}/${bin}.log" ]; then
        mv "${box_run}/${bin}.log" "${box_run}/${bin}.old.log"
      fi
    done
    # åˆ é™¤å…¶ä»–æ—¥å¿—æ–‡ä»¶
    find "${box_run}" -maxdepth 1 -type f \( -name "root" -o \( -name "*.list" -a ! -name "appuid.list" \) -o -name "*.inotify.log" \) -exec rm -f {} +
    # åˆ é™¤ä¸‰å¤©å‰çš„æ—¥å¿—
    find "${box_run}" -maxdepth 1 -type f -name "*.log" -mtime +3 -exec rm -f {} +
  ) &
}

box_bin_alive() {
  local PID=$(<"${box_pid}" 2>/dev/null)
  if ! kill -0 "$PID" 2>/dev/null; then
    log Error "$<"${box_run}/${bin_name}.log")"
    log Error "${bin_name} æœåŠ¡æœªè¿è¡Œã€‚"
    log Error "è¯·æ£€æŸ¥ ${bin_name}.log è·å–è¯¦ç»†ä¿¡æ¯ã€‚"
    log Error "æ¸…ç†æ— æ•ˆ pid $PID"
    for bin in "${bin_list[@]}"; do
      killall -15 "${bin}" >/dev/null 2>&1 || busybox pkill -15 "${bin}" >/dev/null 2>&1 
    done
    "${scripts_dir}/box.iptables" disable >/dev/null 2>&1
    [ -f "${box_pid}" ] && rm -f "${box_pid}"
    exit 1
  else
    return 0
  fi
}

box_run_crontab() {
  # åœæ­¢å·²è¿è¡Œçš„ crondï¼ˆå¯é€‰ï¼‰
  pkill -f "busybox crond" > /dev/null 2>&1
  # å‡†å¤‡ crontab
  busybox crontab -c "${box_run}" -r
  echo "# root çš„å®šæ—¶ä»»åŠ¡" > "${box_run}/root"

  if [ "${run_crontab}" = "true" ]; then
    log Debug "crond å·²å¯ç”¨"
    if [ "$update_subscription" = "true" ] || [ "$update_geo" = "true" ]; then
      log Debug "å®šæ—¶ä»»åŠ¡é—´éš”: ${interva_update}."
      echo "${interva_update} ${scripts_dir}/box.tool geosub" >> "${box_run}/root"
      log Info "${bin_name} geox æ›´æ–°: ${update_geo}."
      if [ "${bin_name}" = "mihomo" ]; then
        log Info "${bin_name} è®¢é˜…æ›´æ–°: ${update_subscription}."
      fi
    fi
    cat "${box_dir}/crontab.cfg" >> "${box_run}/root"
    chmod 0644 "${box_run}/root"
    # åå°å¯åŠ¨ crond
    nohup busybox crond -c "${box_run}" > /dev/null 2>&1 &
  else
    log Info "crond å·²ç¦ç”¨"
  fi
}

box_ownership() {
  # è®¾ç½®å†…æ ¸ç›®å½•æƒé™å’Œå±ä¸»
  chown -R ${box_user_group} ${box_dir}
  chmod -R 644 ${box_dir}/${bin_name}

  chown ${box_user_group} ${bin_path}
  chmod 6755 ${bin_path}

  chmod 0700 ${box_dir}/bin/yq
  chmod 0700 ${box_dir}/bin/curl
}

box_permission() {
  if [[ "${box_user_group}" == @(root:net_admin|0:3005) && -f "${bin_path}" ]]; then
    # è®¾ç½®å†…æ ¸ç›®å½•æƒé™å’Œå±ä¸»
    box_ownership
    log Info "ä½¿ç”¨å†…æ ¸ ${bin_path}ã€‚"
  else
    if  [[ "${box_user_group}" != @(root:net_admin|0:3005) ]]; then
      log Error "ä¸æ”¯æŒçš„ç”¨æˆ·ç»„ [ $box_user_group ]"
      sed -i "s/box_user_group=.*/box_user_group=\"root:net_admin\"/g" ${settings}
      log Debug "å·²è‡ªåŠ¨åˆ‡æ¢ä¸º [ root:net_admin ]ï¼Œè¯·é‡å¯ box"
      exit 1
    fi
    log Error "æœªæ£€æµ‹åˆ°å†…æ ¸ [ ${bin_name} ]ã€‚"
    log Error "è¯·ä¸‹è½½ [ ${bin_name} ] å†…æ ¸å¹¶æ”¾ç½®åˆ° ${bin_dir}/ ç›®å½•ä¸‹ã€‚"
    log Debug "å¯åœ¨ç»ˆç«¯æ‰§è¡Œ 'su -c /data/adb/box/scripts/box.tool upkernel' ä¸‹è½½å†…æ ¸"
    exit 1
  fi
}

box_check_bin() {
  if [ ! -x "${bin_path}" ]; then
    log Error "${bin_path} ä¸å¯æ‰§è¡Œã€‚"
    exit 1
  fi

  local version_output
  case "${bin_name}" in
    mihomo)
      version_output=$("${bin_path}" -v 2>/dev/null) || {
        log Error "${bin_name} ç‰ˆæœ¬ä¿¡æ¯è·å–å¤±è´¥ã€‚"
        exit 1
        }
      ;;
    *)
      version_output=$("${bin_path}" version 2>/dev/null) || {
        log Error "${bin_name} ç‰ˆæœ¬ä¿¡æ¯è·å–å¤±è´¥ã€‚"
        exit 1
        }
      ;;
  esac

  log Info "${version_output}"
}

# create_tun_link() {
  # mkdir -p /dev/net
  # [ ! -L /dev/net/tun ] && ln -s /dev/tun /dev/net/tun

  # if [ ! -c "/dev/net/tun" ]; then
      # log Error "Cannot create /dev/net/tun. Possible reasons:"
      # log Warning "Your system does not support the TUN/TAP driver."
      # log Warning "Your system kernel version is not compatible with the TUN/TAP driver."
      # sed -i 's/network_mode=.*/network_mode="tproxy"/g' "${settings}"
      # exit 1
  # fi
# }

prepare_singbox() {
  # æ£€æŸ¥é…ç½®æ–‡ä»¶
  if ! [ -f "${sing_config}" ]; then
    log Error "æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ ${sing_config}"
    exit 1
  else
    log Info "æ£€æµ‹åˆ°é…ç½® ${sing_config}"
  fi

  # æ£€æŸ¥ yq
  yq="yq"
  if ! command -v yq &>/dev/null; then
    if [ ! -e "${box_dir}/bin/yq" ]; then
      log Debug "æœªæ‰¾åˆ° yqï¼Œå¼€å§‹ä» GitHub ä¸‹è½½"
      ${scripts_dir}/box.tool upyq
    fi
    yq="${box_dir}/bin/yq"
  fi

  # è®¾ç½® auto_detect_interface/auto_route
  ${yq} '.route.auto_detect_interface = true' -i --output-format=json "${sing_config}"
  ${yq} '(.inbounds[] | select(.type == "tun") | .auto_route) |= true' -i --output-format=json "${sing_config}"

  # æ ¼å¼åŒ– sing-box é…ç½®
  if ${bin_path} format -w -D "${box_dir}/${bin_name}" -C "${box_dir}/${bin_name}" > "${box_run}/${bin_name}.log" 2>&1; then
    # æ ¹æ® network_mode è®¾ç½® auto_route
    if [[ "${network_mode}" == @(mixed|tun) ]]; then
      # æ£€æŸ¥é…ç½®ä¸­æ˜¯å¦æœ‰ "type": "tun"
      if ! busybox grep -q '"type": "tun"' "${sing_config}"; then
        # è‹¥æ— åˆ™æ·»åŠ  "tun" é…ç½®
        ${yq} '.inbounds += [{
          "type": "tun",
          "tag": "tun-in",
          "interface_name": "sing",
          "address": ["172.18.0.1/30","fdfe:dcba:9876::1/126"],
          "mtu": 9000,
          "stack": "mixed",
          "auto_route": true,
          "strict_route": true,
          "auto_redirect": true,
          "include_android_user": [0,10],
          "include_uid": [],
          "exclude_uid": []
        }]' -i --output-format=json "${sing_config}"
        log Debug "å·²ä¸º ${sing_config} æ·»åŠ  [Tun] é…ç½®"
      fi
    else
      # é tun æ¨¡å¼ï¼Œå…³é—­ auto_route
      sed -i -e 's/auto_route": true/auto_route": false/g' -e 's/"auto_detect_interface": true/"auto_detect_interface": false/g' "${box_dir}/sing-box/"*.json

      # æ£€æŸ¥æ˜¯å¦æœ‰ tproxy é…ç½®
      if ! busybox grep -q '"type": "tproxy"' "${sing_config}"; then
        # è‹¥æ— åˆ™æ·»åŠ  tproxy é…ç½®
        ${yq} '.inbounds += [{"type": "tproxy", "tag": "tproxy-in", "listen": "::", "listen_port": '"${tproxy_port}"'}]' -i --output-format=json "${sing_config}"
        log Debug "å·²ä¸º ${sing_config} æ·»åŠ  [Tproxy] é…ç½®"
      fi

      # åˆ é™¤ tun é…ç½®
      ${yq} 'del(.inbounds[] | select(.type == "tun"))' -i --output-format=json "${sing_config}"

      # åŒæ­¥ tproxy ç«¯å£
      for file in "${box_dir}/sing-box/"*.json; do
        if busybox grep -q '"type": "tproxy"' "${file}"; then
          ${yq} '(.inbounds[] | select(.type == "tproxy") | .listen_port) = '"${tproxy_port}" -i --output-format=json "${file}"
        fi
      done
    fi

    # ä¸º tun æ·»åŠ  include_uid/exclude_uid å’Œåˆ é™¤æ—§ package å­—æ®µ
    yq_filter='(.inbounds[] | select(.type == "tun") | .include_uid) = [] |
               (.inbounds[] | select(.type == "tun") | .exclude_uid) = [] |
               del(.inbounds[] | select(.type == "tun") | .include_package) |
               del(.inbounds[] | select(.type == "tun") | .exclude_package)'
    
    [[ ${proxy_mode} = "blacklist" || ${proxy_mode} = "black" ]] && mode="exclude" || mode="include"
    
    local uids_to_add=""
    if [ -s "${uid_list}" ]; then
      uids_to_add=$(busybox tr '\n' ',' < "${uid_list}" | sed 's/,$//')
      if [ -n "$uids_to_add" ]; then
        yq_filter="$yq_filter | (.inbounds[] | select(.type == \"tun\") | .${mode}_uid) = [${uids_to_add}]"
      fi
    fi
    "${yq}" eval "$yq_filter" -i --output-format=json "${sing_config}" > /dev/null 2>&1
    log_service_results "sing-box" "$mode" "$uids_to_add"

    # æŒ‰ network_mode æ·»åŠ  redirect é…ç½®
    if [[ "${network_mode}" == @(mixed|enhance|redirect) ]]; then
      if ! busybox grep -q '"type": "redirect"' "${sing_config}"; then
        # è‹¥æ— åˆ™æ·»åŠ  redirect é…ç½®
        ${yq} '.inbounds += [{
          "type": "redirect",
          "tag": "redirect-in",
          "listen": "::",
          "listen_port": '"${redir_port}"'
        }]' -i --output-format=json "${sing_config}"
        log Debug "å·²ä¸º ${sing_config} æ·»åŠ  [Redirect] é…ç½®"
      fi

      # åŒæ­¥ redir_port ç«¯å£
      for file in "${box_dir}/sing-box/"*.json; do
        if busybox grep -q '"type": "redirect"' "${file}"; then
          ${yq} '(.inbounds[] | select(.type == "redirect") | .listen_port) = '"${redir_port}" -i --output-format=json "${file}"
        fi
      done
    fi
  else
    log Error "$<"${box_run}/${bin_name}.log")"
    log Error "é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ ${box_run}/${bin_name}.log æ–‡ä»¶ã€‚"
    exit 1
  fi
}

prepare_mihomo() {
  # æ£€æŸ¥é…ç½®æ–‡ä»¶
  if ! [ -f "${mihomo_config}" ]; then
    log Error "æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ ${mihomo_config}"
    exit 1
  else
    log Info "æ£€æµ‹åˆ°é…ç½® ${mihomo_config}"
  fi

  # å†™å…¥ external_controllerï¼Œå¦‚æœªé…ç½®
  mihomo_external_controller=$(busybox awk '!/^ *#/ && /external-controller: /{print $1}' "${mihomo_config}")
  if [ -z "${mihomo_external_controller}" ]; then
    printf "\nexternal-controller: 0.0.0.0:9090" >> "${mihomo_config}"
  fi

  # å†™å…¥ external_uiï¼Œå¦‚æœªé…ç½®
  mihomo_external_ui=$(busybox awk '!/^ *#/ && /external-ui: /{print $1}' "${mihomo_config}")
  if [ -z "${mihomo_external_ui}" ]; then
    printf "\nexternal-ui: ./dashboard" >> "${mihomo_config}"
  fi

  # å†™å…¥ tproxy-portï¼Œå¦‚æœªé…ç½®
  mihomo_tproxy_port=$(busybox awk '!/^ *#/ && /tproxy-port: /{print $1}' "${mihomo_config}")
  if [ -z "${mihomo_tproxy_port}" ]; then
    printf "\ntproxy-port: ${tproxy_port}" >> "${mihomo_config}"
  fi

  # å†™å…¥ redir-portï¼Œå¦‚æœªé…ç½®
  mihomo_redir_port=$(busybox awk '!/^ *#/ && /redir-port: /{print $1}' "${mihomo_config}")
  if [ -z "${mihomo_redir_port}" ]; then
    printf "\nredir-port: ${redir_port}" >> "${mihomo_config}"
  fi

  if [[ "${network_mode}" == @(mixed|tun) ]]; then
    mihomo_tun_status=$(busybox awk '!/^ *#/ && /tun:/ { getline; split($0, arr, ": "); print arr[2]; found=1; exit } END{ if (!found) print "" }' "${mihomo_config}" 2>/dev/null)
    # å†™å…¥ TUN é…ç½®ï¼Œå¦‚æœªé…ç½®
    if [ -z "${mihomo_tun_status}" ]; then
      printf '%s\n' '' 'tun:' \
        '  enable: true' \
        '  mtu: 9000' \
        '  device: meta' \
        '  stack: mixed # / gvisor / system' \
        '  dns-hijack:' \
        '    - any:53' \
        '    - tcp://any:53' \
        '  auto-route: true' \
        '  strict-route: true' \
        '  auto-redirect: true' \
        '  auto-detect-interface: true' \
        '  include-android-user: [0, 10]' \
        '  exclude-uid: []' \
        '  include-uid: []' \ >> "${mihomo_config}"
      log Debug "å·²ä¸º ${mihomo_config} æ·»åŠ  [tun] é…ç½®"
    else
      log Info  "${mihomo_config} å·²å­˜åœ¨ [tun] é…ç½®"
    fi

    # ä¸º tun æ·»åŠ  include-uid/exclude-uid
    if [ -f "${uid_list}" ]; then
        list_uid=$(busybox tr '\n' ',' < "${uid_list}" | sed 's/,$//')
    else
        list_uid=""
    fi

    if [[ "${proxy_mode}" = "whitelist" || "${proxy_mode}" = "white" ]]; then
      mode="include"
    elif [[ "${proxy_mode}" = "blacklist" || "${proxy_mode}" = "black" ]]; then
      mode="exclude"
    fi

    # å…¼å®¹æ—§é…ç½®ï¼Œåˆ é™¤ package å­—æ®µ; é‡ç½® include/exclude_uid; å¯ç”¨tun
    sed -i -e "/^tun:/,/^[^ ]/ { /exclude-package:/d; /include-package:/d; }" \
        -e "s/exclude-uid:.*/exclude-uid: []/g" \
        -e "s/include-uid:.*/include-uid: []/g" \
        -e "/tun:/,/enable:/ { /enable: false/ s/enable: false/enable: true/ }" \
        "${mihomo_config}"


    # æ£€æŸ¥ tun å—ä¸­æ˜¯å¦æœ‰ include-uid/exclude-uid
    uid_found=$(busybox awk '/^tun:/{f=1} f && /'"$mode-uid:"'/{print $0; exit}' "$mihomo_config")
    if [ -z "$uid_found" ]; then
        sed -i "/^tun:/a \  $mode-uid: []" "$mihomo_config"
    fi

    # æ·»åŠ uidåˆ°é…ç½®
    if [ -n "${list_uid}" ]; then
      sed -i "s/${mode}-uid:.*/${mode}-uid: [${list_uid}]/g" "${mihomo_config}"
    fi
    log_service_results "mihomo" "$mode" "$list_uid"

  else
    sed -i "/tun:/,/enable:/ { /enable: true/ s/enable: true/enable: false/ }" "${mihomo_config}"
  fi

  # åŒæ­¥ tproxy/redir ç«¯å£
  sed -i -E "s/(tproxy-port: )[0-9]+/\1${tproxy_port}/" "${mihomo_config}"
  sed -i -E "s/(redir-port: )[0-9]+/\1${redir_port}/" "${mihomo_config}"

  mihomo_enhanced_mode=$(busybox awk '!/^ *#/ && /enhanced-mode: / { print $2 }' "${mihomo_config}" 2>/dev/null)
  if [ -z "${mihomo_enhanced_mode}" ]; then
    # æ·»åŠ  enhanced-mode: fake-ip
    sed -i '/dns:/ {n; /enable:.*/ {a\  enhanced-mode: fake-ip}}' "$mihomo_config"
    log Debug "å·²æ·»åŠ  enhanced-mode: fake-ip"
  fi

  if [[ "${network_mode}" == @(mixed|tproxy|redirect|enhance) ]]; then
    if [[ -n "${packages_list[*]}" || -n "${ignore_out_list[*]}" || -n "${gid_list[*]}" ]] && [ "${mihomo_enhanced_mode}" = "fake-ip" ]; then
      log Warning "${proxy_mode} ä»…åœ¨ mihomo çš„ enhanced-mode: redir-host ä¸‹ç”Ÿæ•ˆ"
      log Warning "å·²å°† fake-ip æ›¿æ¢ä¸º redir-host"
      sed -i "s/enhanced-mode:.*/enhanced-mode: redir-host/g" "${mihomo_config}"
      sed -i "/sniffer:/,/enable:/ { /enable: false/ s/enable: false/enable: true/ }" "${mihomo_config}"
    fi
  fi
}

box_run_bin() {
  log Info "å¯ç”¨å†…æ ¸åˆ—è¡¨: [ ${bin_list[*]} ]"
  log Info "é€‰æ‹©å†…æ ¸: ${bin_name}ï¼Œå¯åŠ¨æœåŠ¡ã€‚"
  ulimit -SHn 1000000

  # ä¸º Go æ ¸å¿ƒè®¾ç½®å†…å­˜é™åˆ¶ (å•ä½: MiB)
  # æ‚¨å¯ä»¥åœ¨ settings.ini ä¸­æ·»åŠ  memory_limit="200" æ¥è¦†ç›–æ­¤é»˜è®¤å€¼
  local MEM_LIMIT="${memory_limit:-150}MiB"
  log Info "ä¸ºæ ¸å¿ƒè®¾ç½®å†…å­˜é™åˆ¶: ${MEM_LIMIT}"
  local RUN_CMD="nohup busybox setuidgid ${box_user_group} env GOMEMLIMIT=${MEM_LIMIT}"

  case "${bin_name}" in
    hysteria)
      # åŒæ­¥ç«¯å£
      sed -i -e "/tcpTProxy:/,/listen:/s/listen: :.*/listen: :${tproxy_port}/" "${box_dir}/${bin_name}/config.yaml"
      sed -i -e "/udpTProxy:/,/listen:/s/listen: :.*/listen: :${tproxy_port}/" "${box_dir}/${bin_name}/config.yaml"
      sed -i -e "/tcpRedirect:/,/listen:/s/listen: :.*/listen: :${redir_port}/" "${box_dir}/${bin_name}/config.yaml"

      # éªŒè¯ network_mode for hysteria
      case "${network_mode}" in
        redirect|tproxy|enhance)
          # æ”¯æŒçš„æ¨¡å¼ï¼Œæ— éœ€æ“ä½œ
          ;;
        *)
          # ä¸æ”¯æŒçš„æ¨¡å¼ï¼Œåˆ‡æ¢å› tproxy
          sed -i 's/\(network_mode=\)"[^\"]*"/\1"tproxy"/g' ${settings}
          ;;
      esac
      ${RUN_CMD} ${bin_path} -c ${box_dir}/${bin_name}/config.yaml > "${bin_log}" 2>&1 &
      PID=$!
      echo -n $PID > "${box_pid}"
      ;;
    sing-box)
      if [ "${auto_modify_config}" = "true" ]; then
        prepare_singbox
      fi
      if ${bin_path} check -D "${box_dir}/${bin_name}" -C "${box_dir}/${bin_name}" > "${box_run}/${bin_name}.log" 2>&1; then
        ${RUN_CMD} "${bin_path}" run -D "${box_dir}/${bin_name}" -C "${box_dir}/${bin_name}" > "${bin_log}" 2>&1 &
        PID=$!
        echo -n $PID > "${box_pid}"
      else
        log Error "$<"${box_run}/${bin_name}.log")"
        log Error "é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ ${box_run}/${bin_name}.log æ–‡ä»¶ã€‚"
        exit 1
      fi
      ;;
    mihomo)
      if [ "${auto_modify_config}" = "true" ]; then
        prepare_mihomo
      fi
      if ${bin_path} -t -d "${box_dir}/${bin_name}" -f "${mihomo_config}" > "${box_run}/${bin_name}.log" 2>&1; then
        ${RUN_CMD} "${bin_path}" -d "${box_dir}/${bin_name}" -f "${mihomo_config}" > "${bin_log}" 2>&1 &
        PID=$!
        echo -n $PID > "${box_pid}"
      else
        log Error "$<"${box_run}/${bin_name}.log")"
        log Error "é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ ${box_run}/${bin_name}.log æ–‡ä»¶ã€‚"
        exit 1
      fi
      ;;
    xray)
      if [[ "${network_mode}" != "tproxy" ]]; then
        sed -i 's/\(network_mode=\)"[^\"]*"/\1"tproxy"/g' ${settings}
      fi
      ${box_dir}/bin/yq '(.inbounds[] | select(.protocol == "dokodemo-door") | .port) = '"${tproxy_port}"'' -i --output-format=yaml "${box_dir}/${bin_name}/config.yaml" >/dev/null 2>&1
      ${box_dir}/bin/yq '(.inbounds[] | select(.protocol == "dokodemo-door") | select(.tag == "tproxy-in") | .port) = '"${tproxy_port}" -i --output-format=json "${box_dir}/${bin_name}/config.json" >/dev/null 2>&1
      if [ ! -f "${box_dir}/${bin_name}/config.toml" ] && [ ! -f "${box_dir}/${bin_name}/config.json" ] && [ ! -f "${box_dir}/${bin_name}/config.yaml" ]; then
        log Error "æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼ŒæœŸæœ› config.tomlã€config.json æˆ– config.yaml"
        if [ -f "${box_pid}" ]; then
          rm -f "${box_pid}"
          log Info "å·²ç§»é™¤ PID æ–‡ä»¶: ${box_pid}"
        fi
        exit 1
      else
        log Info "å·²æ‰¾åˆ°é…ç½®æ–‡ä»¶ (config.toml, .json, .yaml ä¹‹ä¸€)"
      fi
      export XRAY_LOCATION_ASSET="${box_dir}/${bin_name}"
      if ${bin_path} -test -confdir "${box_dir}/${bin_name}" > "${box_run}/${bin_name}.log" 2>&1; then
        ${RUN_CMD} ${bin_path} run -confdir "${box_dir}/${bin_name}" > "${bin_log}" 2>&1 &
        PID=$!
        echo -n $PID > "${box_pid}"
      else
        log Error "$<"${box_run}/${bin_name}.log")"
        log Error "é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ ${box_run}/${bin_name}.log æ–‡ä»¶ã€‚"
        exit 1
      fi
      ;;
    v2fly)
      if [[ "${network_mode}" != "tproxy" ]]; then
        sed -i 's/\(network_mode=\)"[^\"]*"/\1"tproxy"/g' ${settings}
      fi
      ${box_dir}/bin/yq '(.inbounds[] | select(.protocol == "dokodemo-door") | .port) = '"${tproxy_port}"'' -i --output-format=yaml "${box_dir}/${bin_name}/config.yaml" >/dev/null 2>&1
      ${box_dir}/bin/yq '(.inbounds[] | select(.protocol == "dokodemo-door") | select(.tag == "tproxy-in") | .port) = '"${tproxy_port}" -i --output-format=json "${box_dir}/${bin_name}/config.json" >/dev/null 2>&1
      if [ ! -f "${box_dir}/${bin_name}/config.toml" ] && [ ! -f "${box_dir}/${bin_name}/config.json" ] && [ ! -f "${box_dir}/${bin_name}/config.yaml" ]; then
        log Error "æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼ŒæœŸæœ› config.tomlã€config.json æˆ– config.yaml"
        if [ -f "${box_pid}" ]; then
          rm -f "${box_pid}"
          log Info "å·²ç§»é™¤ PID æ–‡ä»¶: ${box_pid}"
        fi
        exit 1
      else
        log Info "å·²æ‰¾åˆ°é…ç½®æ–‡ä»¶ (config.toml, .json, .yaml ä¹‹ä¸€)"
      fi
      export V2RAY_LOCATION_ASSET="${box_dir}/${bin_name}"
      if ${bin_path} test -d "${box_dir}/${bin_name}" > "${box_run}/${bin_name}.log" 2>&1; then
        ${RUN_CMD} ${bin_path} run -d "${box_dir}/${bin_name}" > "${bin_log}" 2>&1 &
        PID=$!
        echo -n $PID > "${box_pid}"
      else
        log Error "$<"${box_run}/${bin_name}.log")"
        log Error "é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ ${box_run}/${bin_name}.log æ–‡ä»¶ã€‚"
        exit 1
      fi
      ;;
    *)
      log Error "[ ${bin_name} ] æœªçŸ¥å†…æ ¸ã€‚"
      exit 1
      ;;
  esac
}

box_cgroup() {
  set_cgroup_config() {
    local cgroup_attr="$1"
    local cgroup_value="$2"

    if [ "${cgroup_value}" = "true" ]; then
      if ${scripts_dir}/box.tool "${cgroup_attr}"; then
        true
      else
        log Warning "æ— æ³•ä¸º ${bin_name} å¯ç”¨ ${cgroup_attr}"
        log Warning "å·²å…³é—­ cgroups ${cgroup_attr}"
        sed -i -E "/cgroup_${cgroup_attr}/ s/(true)/false/" "${settings}"
      fi
    fi
  }
  set_cgroup_config "memcg" "${cgroup_memcg}"
  set_cgroup_config "cpuset" "${cgroup_cpuset}"
  set_cgroup_config "blkio" "${cgroup_blkio}"
}

# æ˜¾ç¤ºè¿›ç¨‹çŠ¶æ€ä¿¡æ¯
box_bin_status() {
  # è·å–è¿›ç¨‹ PID
  local PID=$(busybox pidof ${bin_name})

  if [ -z "$PID" ]; then
    log Error "${bin_name} æœªåœ¨è¿è¡Œ"
    return 1
  fi

  stack=$(if [ "${bin_name}" != "mihomo" ]; then find "/data/adb/box/sing-box" -type f -name "*.json" -exec busybox awk -F'"' '/"stack"/{print $4}' {} +; else busybox awk '!/^ *#/ && /stack: / { print $2;found=1; exit}' "${mihomo_config}"; fi)
  TOAST=1 log Info "${bin_name} æœåŠ¡æ­£åœ¨è¿è¡Œ"

  log Info "ä»£ç†æ¨¡å¼: ${proxy_mode} + ç½‘ç»œæ¨¡å¼: ${network_mode} + $(if [[ "${network_mode}" == @(mixed|tun) ]]; then echo "åè®®æ ˆ: ${stack}"; fi)"

  # è·å–å†…å­˜ä½¿ç”¨æƒ…å†µ
  awk_script='
    /VmRSS/ {rss=$2}
    /VmSwap/ {swap=$2}
    /State/ {state=$2" "$3}
    END {
      rss_str = rss " KB"; if (rss >= 1024) rss_str = int(rss/1024) " MB";
      swap_str = swap " KB"; if (swap >= 1024) swap_str = int(swap/1024) " MB";
      print rss_str, swap_str, state
    }
  '
  read -r bin_rss bin_swap state <<< "$(awk "$awk_script" /proc/$PID/status)"

  # è·å–ç”¨æˆ·ç»„ä¿¡æ¯
  user_group=$(stat -c %U:%G /proc/$PID)

  # è®°å½•ä¿¡æ¯åˆ°æ—¥å¿—
  log Info "${bin_name} ä»¥ '${user_group}' ç”¨æˆ·ç»„å¯åŠ¨"
  log Info "${bin_name} çŠ¶æ€: ${state} (PID: $PID)"
  log Info "${bin_name} å†…å­˜å ç”¨: ${bin_rss}, äº¤æ¢: ${bin_swap}"

  # è·å– CPU ä½¿ç”¨ç‡
  cpu=$(ps -p $PID -o %cpu | busybox awk 'NR==2{print $1}' 2> /dev/null)

  cpus_allowed=$(grep Cpus_allowed_list /proc/$PID/status | busybox awk '{ print $2" "$3 }')
  core=$(busybox awk '{print $39}' /proc/$PID/stat 2>/dev/null)

  if [ -n "${cpu}" ]; then
    log Info "${bin_name} CPU ä½¿ç”¨ç‡: ${cpu}%"
  else
    log Info "${bin_name} CPU ä½¿ç”¨ç‡: æ— æ³•è·å–"
  fi
  if [ -n "${cpus_allowed}" ]; then
    log Info "${bin_name} å…è®¸ä½¿ç”¨çš„ CPU æ ¸å¿ƒ: ${cpus_allowed}"
    log Info "${bin_name} è¿›ç¨‹ $PID æœ€åè¿è¡Œåœ¨ CPU æ ¸å¿ƒ: ${core}"
  else
    log Info "${bin_name} è¿è¡Œçš„ CPU æ ¸å¿ƒ: æ— æ³•è·å–"
  fi

  # æ£€æŸ¥ç”µæ± æ¸©åº¦
  temperature_celsius=$(($(cat /sys/class/power_supply/battery/temp) / 10))
  log Info "ç”µæ± æ¸©åº¦: ${temperature_celsius}Â°C"

  # è·å–è¿è¡Œæ—¶é—´
  running_time=$(busybox ps -o comm,etime | grep ${bin_name} | busybox awk '{print $2}')
  if [ -n "${running_time}" ]; then
    log Info "${bin_name} è¿è¡Œæ—¶é—´: ${running_time}"
  else
    log Info "${bin_name} è¿è¡Œæ—¶é—´: æ— æ³•è·å–"
  fi
  
  (
    # æœ¬åœ° IP
    localIP=($(ip -4 a | awk '/inet / && !/127.0.0.1/ { split($2, a, "/"); print a[1] }'))
    log Info "æœ¬åœ° IP: ${localIP[*]}"
    # æœ¬åœ° DNS
    localDNS=($(dumpsys connectivity | awk -F'[ ,]' '/DnsAddresses:/ { for (i=1; i<=NF; i++) if ($i ~ /^\/.*$/) { dns=substr($i, 2); if (dns ~ /^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/) print dns } }'))
    log Info "æœ¬åœ° DNS: ${localDNS[*]}"
  ) &


  # ä¿å­˜è¿›ç¨‹ ID åˆ° pid æ–‡ä»¶
  if [ -n "$PID" ]; then
    get_dns_mode
    set_description running
    echo -n "$PID" > "${box_pid}"
  fi
}

# ========== æ–°å¢ set_description å‡½æ•° ===========
set_description() {
  local status="$1" # running, stopped, idle
  local desc=""
  local ipv6_info=""
  local wifissid_str=""
  local ssid_mode_str=""
  local ssid_list_str=""

  # IPv6çŠ¶æ€
  if [ "${ipv6}" = "true" ]; then
    ipv6_info="å·²å¯ç”¨"
  else
    ipv6_info="æœªå¯ç”¨"
  fi

  # ä»…åœ¨æœåŠ¡è¿è¡Œä¸”å¼€å¯ WiFi SSID åŒ¹é…æ—¶æ˜¾ç¤º
  if [ "$status" = "running" ] && [ "${use_ssid_matching}" = "true" ]; then
    # åˆ¤æ–­é»‘ç™½åå•æ¨¡å¼
    if [ "${use_wifi_list_mode}" = "blacklist" ]; then
      ssid_mode_str="é»‘åå•"
    elif [ "${use_wifi_list_mode}" = "whitelist" ]; then
      ssid_mode_str="ç™½åå•"
    else
      ssid_mode_str="æœªçŸ¥æ¨¡å¼"
    fi
    # å¦‚æœå˜é‡å†…å®¹åŒ…å«é€—å·ï¼Œæ›¿æ¢ä¸ºç©ºæ ¼ï¼Œä¾¿äºæ˜¾ç¤º
    ssid_list_str="${wifi_ssids_list//,/ }"
    # ä»…å½“ SSID åˆ—è¡¨éç©ºæ—¶æ‰æ˜¾ç¤º
    if [ -n "$ssid_list_str" ]; then
      wifissid_str=" | WiFi SSIDåˆ—è¡¨ï¼ˆ${ssid_mode_str}ï¼‰: ${ssid_list_str}"
    fi
  fi

  case "$status" in
    running)
      desc="âœ… BoxæœåŠ¡è¿è¡Œä¸­ | å†…æ ¸: ${bin_name} | ä»£ç†æ¨¡å¼: ${proxy_mode} | ç½‘ç»œ: ${network_mode} | IPv6çŠ¶æ€: ${ipv6_info} | DNSæ¨¡å¼: ${dns_mode}${wifissid_str}"
      ;;
    stopped)
      desc="âŒ BoxæœåŠ¡å·²åœæ­¢ | ä¸Šæ¬¡è¿è¡Œå†…æ ¸: ${bin_name} | ä»£ç†å·²ç¦ç”¨"
      ;;
    idle)
      desc="âœ¨ Boxæ¨¡å—å·²åŠ è½½ï¼Œç­‰å¾…æœåŠ¡å¯åŠ¨"
      ;;
    *)
      desc="ğŸ’¤ BoxçŠ¶æ€æœªçŸ¥"
      ;;
  esac
  sed -Ei "s/^description=.*/description=${desc}/g" "$PROPFILE"
}
get_dns_mode() {
  dns_mode="æœªçŸ¥"
  if [ "${bin_name}" = "mihomo" ]; then
    if grep -q "enhanced-mode: redir-host" "${mihomo_config}" 2>/dev/null; then
      dns_mode="redir-host"
    elif grep -q "enhanced-mode: fake-ip" "${mihomo_config}" 2>/dev/null; then
      dns_mode="fake-ip"
    fi
  elif [ "${bin_name}" = "sing-box" ]; then
    if grep -q '"type" *: *"fakeip"' "${sing_config}" 2>/dev/null; then
      dns_mode="fake-ip"
    else
      dns_mode="redir-host"
    fi
  fi
  export dns_mode
}

start_box() {
  find_packages_uid
  get_dns_mode
  set_description running

  echo -n "" > "${box_log}"
  box_version=$(busybox awk '!/^ *#/ && /version=/ { print $0 }' "/data/adb/modules/box_for_root/module.prop" 2>/dev/null)

  if [ -t 1 ]; then
    echo -e "${yellow}$(getprop persist.sys.timezone) $(date)${normal}"
    echo -e "${yellow}$(getprop gsm.sim.operator.alpha) $(getprop gsm.network.type)${normal}"
    echo -e "${yellow}${box_version}($(getprop ro.product.cpu.abi))${normal}"
    echo -e "${white}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${normal}"
  else
    {
      echo "$(getprop persist.sys.timezone) $(date)"
      echo "$(getprop gsm.sim.operator.alpha) $(getprop gsm.network.type)"
      echo "${box_version}($(getprop ro.product.cpu.abi))"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    } | tee -a "${box_log}" > /dev/null 2>&1
  fi

  # å¦‚æœ bin_name ä»åœ¨è¿è¡Œåˆ™æ›´æ–° iptables
  PIDS=("${bin_list[@]}")
  PID=""
  i=0

  while [ -z "$PID" ] && [ "$i" -lt "${#PIDS[@]}" ]; do
    PID=$(busybox pidof "${PIDS[$i]}")
    i=$((i+1))
  done

  if [ -n "$PID" ]; then
    pid_name="${box_dir}/run/pid_name.txt"
    ps -p $PID -o comm= > "${pid_name}"
    sed -i '/^[[:space:]]*$/d' "${pid_name}"
    log Debug "$(<"${pid_name}")(PID: $PID) æœåŠ¡ä»åœ¨è¿è¡Œï¼Œè‡ªåŠ¨é‡å¯ BOX"
    rm -f "${pid_name}"
    stop_box
    start_box && "${scripts_dir}/box.iptables" renew
    exit 1
  fi

  # æ£€æŸ¥ bin_name æ˜¯å¦å·²å®šä¹‰
  case "${bin_name}" in
    mihomo|xray|sing-box|v2fly|hysteria)
      log Info "å¯åŠ¨æœåŠ¡"
      ;;
    *)
      log Error "bin_name: [ ${bin_name} ] æœªå®šä¹‰æˆ–æœªçŸ¥"
      exit 1
      ;;
  esac

  # busybox æ£€æŸ¥
  busybox_code=$(busybox | busybox grep -oE '[0-9.]*' | head -n 1)
  if [ "$(echo "${busybox_code}" | busybox awk -F. '{printf "%03d%03d%03d\n", $1, $2, $3}')" -lt "$(echo "1.36.1" | busybox awk -F. '{printf "%03d%03d%03d\n", $1, $2, $3}')" ]; then
    log Info "å½“å‰ $(which busybox) v${busybox_code}"
    log Warning "è¯·å°† busybox æ›´æ–°åˆ° v1.36.1+"
  else
    log Info "å½“å‰ $(which busybox) v${busybox_code}"
  fi

  # æ£€æŸ¥æƒé™ï¼Œæ£€æŸ¥å†…æ ¸æ˜¯å¦å­˜åœ¨ï¼Œåˆ é™¤æ—§æ—¥å¿—ï¼Œå¦‚æœ‰å¿…è¦åˆ›å»º TUNï¼Œè¿è¡Œå†…æ ¸ï¼Œç­‰å¾… 1 ç§’
  box_permission
  box_check_bin
  box_check_logs

  # å¦‚æœ run_crontab ä¸ç­‰äº "false" åˆ™æ‰§è¡Œ box_run_crontab
  [ "${run_crontab}" = "true" ] && box_run_crontab || log Info "å®šæ—¶ä»»åŠ¡å·²ç¦ç”¨"

  if [ -z "${proxy_mode}" ]; then
    M1=$(busybox awk '!/^ *#/ && /mode:/{print $0}' "${pkg_config}")
    [ -z $M1 ] && printf "\nmode:white" >> "${pkg_config}"
    log Debug "ä»£ç†æ¨¡å¼ä¸ºç©ºï¼Œåœ¨ ${pkg_config} ä¸­æ·»åŠ  mode:white"
  fi

  # æ‰§è¡Œ box_cgroup, box_run_bin, box_detected_port, box_bin_alive å‡½æ•°
  box_run_bin
  box_cgroup

  count=0
  while [ $count -le 5 ]; do
    sleep 0.1
    box_bin_alive || break
    count=$((count + 1))
  done

  true
}

stop_box() {
  stop_cron
  local PID
  PID=$(cat "${box_pid}" 2>/dev/null)

  if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
    kill -15 "$PID" >/dev/null 2>&1
  else
    # å¦‚æœPIDæ–‡ä»¶æ— æ•ˆï¼Œåˆ™å›é€€åˆ°pkill
    for bin in "${bin_list[@]}"; do
      busybox pkill -15 "${bin}" >/dev/null 2>&1
    done
  fi

  # æ£€æŸ¥å†…æ ¸æ˜¯å¦å·²åœæ­¢
  sleep 0.2
  if ! busybox pgrep -f "${bin_name}" >/dev/null 2>&1; then
    rm -f "${box_pid}"
    log Warning "${bin_name} å·²å…³é—­ï¼ŒæœåŠ¡å·²åœæ­¢"
    TOAST=1 log Warning "${bin_name} å·²æ–­å¼€è¿æ¥"
    [ -t 1 ] && echo -e "${white}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${normal}"
  else
    log Warning "${bin_name} æœªåœæ­¢ï¼›å¯èƒ½ä»åœ¨å…³é—­è¿‡ç¨‹ä¸­æˆ–å…³é—­å¤±è´¥"
    force_stop
  fi

  set_description stopped
}

stop_cron() {
  # ä½¿ç”¨ pkill åœæ­¢ crond
  if ! busybox pkill -f "busybox crond" > /dev/null 2>&1; then
    # å¦‚æœ pkill å¤±è´¥ï¼ŒæŸ¥æ‰¾å¹¶ç»ˆæ­¢è¿›ç¨‹
    cronkill=$(busybox pgrep -f "crond -c ${box_run}")
    for cron in ${cronkill[@]}; do
      kill -15 "${cron}" 2>/dev/null
    done
  fi
}

force_stop() {
  # å°è¯•å¼ºåˆ¶å…³é—­
  log Warning "å°è¯•å¼ºåˆ¶å…³é—­"
  local PID
  PID=$(cat "${box_pid}" 2>/dev/null)

  if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
    kill -9 "$PID" >/dev/null 2>&1
  else
    for bin in "${bin_list[@]}"; do
      busybox pkill -9 "${bin}" >/dev/null 2>&1
    done
  fi

  sleep 0.2
  if ! busybox pgrep -f "${bin_name}" >/dev/null 2>&1; then
    log Warning "å®Œæˆï¼Œç°åœ¨å¯ä»¥å®‰å¿ƒä¼‘æ¯äº†"
    rm -f "${box_pid}"
  fi
}

# æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å®‰è£…äº† busybox
if ! command -v busybox &> /dev/null; then
  log Error "$(which busybox) å‘½ä»¤æœªæ‰¾åˆ°"
  exit 1
fi

case "$1" in
  start)
    stop_box >> /dev/null 2>&1
    if start_box; then
        $scripts_dir/box.tool webroot >/dev/null 2>&1
    fi
    ;;
  stop)
    stop_box
    ;;
  restart)
    "${scripts_dir}/box.iptables" disable && stop_box
    sleep 0.2
    if start_box; then
      "${scripts_dir}/box.iptables" renew
      $scripts_dir/box.tool webroot >/dev/null 2>&1
    fi
    ;;
  status)
    # æ£€æŸ¥æœåŠ¡æ˜¯å¦åœ¨è¿è¡Œ
    if busybox pidof "${bin_name}" >/dev/null; then
      case "${bin_name}" in
        mihomo) echo "${yellow}$("${bin_path}" -v)${normal}";;
        *) echo "${yellow}$("${bin_path}" version)${normal}";;
      esac
      box_bin_status
    else
      log Warning "${bin_name} å·²å…³é—­ï¼ŒæœåŠ¡å·²åœæ­¢"
    fi
    ;;
  cron)
    run_crontab="true"
    stop_cron
    sleep 0.2
    box_run_crontab
    ;;
  kcron)
    stop_cron
    ;;
  *)
    echo "${red}$0 $1 æœªæ‰¾åˆ°${normal}"
    echo "${yellow}ç”¨æ³•${normal}: ${green}$0${normal} {${yellow}start|stop|restart|status|cron|kcron${normal}}"
    ;;
esac